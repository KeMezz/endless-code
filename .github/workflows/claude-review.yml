name: Claude Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  review:
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Bash ë„êµ¬ í—ˆìš© (gh CLI, git ëª…ë ¹ ì‚¬ìš©ì„ ìœ„í•´)
          allowed_tools: "Bash(gh *),Bash(git diff*),Bash(git log*),Bash(git show*),Read,Glob,Grep"

          # Claudeê°€ CI ê²°ê³¼ ì½ê¸° í—ˆìš©
          additional_permissions: |
            actions: read

          # ì»¤ìŠ¤í…€ ë¦¬ë·° í”„ë¡¬í”„íŠ¸
          prompt: |
            PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•˜ì„¸ìš”.

            ## ë¦¬ë·° ë°©ë²•

            1. `git diff origin/main...HEAD`ë¡œ ë³€ê²½ì‚¬í•­ í™•ì¸
            2. ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
            3. ë¬¸ì œ ë°œê²¬ ì‹œ í”¼ë“œë°± ì œê³µ

            ## í”¼ë“œë°± í˜•ì‹

            ### ì¸ë¼ì¸ ì½”ë©˜íŠ¸ (íŠ¹ì • ë¼ì¸ì— ë¬¸ì œê°€ ìˆëŠ” ê²½ìš°)
            í•´ë‹¹ íŒŒì¼ì˜ íŠ¹ì • ë¼ì¸ì— ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

            ### ì¼ë°˜ ì½”ë©˜íŠ¸ (ì „ì²´ì ì¸ í”¼ë“œë°±)
            - ì•„í‚¤í…ì²˜ ê´€ë ¨ ì˜ê²¬
            - ì—¬ëŸ¬ íŒŒì¼ì— ê±¸ì¹œ íŒ¨í„´ ë¬¸ì œ
            - í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì „ë°˜
            - ì¸ë¼ì¸ìœ¼ë¡œ í‘œí˜„í•˜ê¸° ì–´ë ¤ìš´ ë‚´ìš©

            ## ì‹¬ê°ë„

            ğŸ”´ **Critical**: ë²„ê·¸, ë³´ì•ˆ, í¬ë˜ì‹œ - ë°˜ë“œì‹œ ìˆ˜ì • í•„ìš”
            ğŸŸ¡ **Warning**: ì—ëŸ¬í•¸ë“¤ë§, ì„±ëŠ¥ - ìˆ˜ì • ê¶Œì¥
            ğŸŸ¢ **Suggestion**: ê°€ë…ì„±, ë„¤ì´ë° - ì„ íƒì 

            ## ì¸ë¼ì¸ ì½”ë©˜íŠ¸ í˜•ì‹

            ```
            ğŸ”´ **Critical**: <ìš”ì•½>

            **ë¬¸ì œ**: <ì„¤ëª…>
            **í•´ê²°**: <ë°©ë²•>

            ```suggestion
            <ìˆ˜ì • ì½”ë“œ>
            ```
            ```

            ## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸

            - Swift 6.2+ / SwiftUI (Strict Concurrency)
            - Vapor 4 ì„œë²„
            - 80% í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìš”êµ¬
            - Actor ê¸°ë°˜ ë™ì‹œì„±

            ## ì£¼ì˜

            - ë³€ê²½ë˜ì§€ ì•Šì€ ì½”ë“œì—ëŠ” ì½”ë©˜íŠ¸ ê¸ˆì§€
            - êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ í”¼ë“œë°±ë§Œ ì œê³µ
